name: Repair Supabase Migration History

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type YES to confirm repair'
        required: true
        default: 'NO'

jobs:
  repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Link to Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          cd backend/supabase
          npx supabase link --project-ref "$SUPABASE_PROJECT_ID"

      - name: Bulk Repair Migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          cd backend/supabase
          
          if [ "${{ github.event.inputs.confirm }}" != "YES" ]; then
            echo "‚ùå Confirmation missing. Skipping repair. Run again with confirm=YES."
            npx supabase migration list
            exit 0
          fi

          # List of migration timestamps derived from local files
          # Only including versions OLDER than the baseline (20260116000000)
          MIGRATIONS=(
            20250811062708
            20250812032300
            20250819072116
            20250825065500
            20250825065700
            20250825101500
            20250825101501
            20250925071946
            20251120004400
            20251206000000
            20251211000000
            20251217
            20251219000000
            20251219150000
            20251231000000
            20251231010000
            20260103170500
          )

          echo "üõ†Ô∏è Starting Bulk Repair for ${#MIGRATIONS[@]} migrations..."

          for v in "${MIGRATIONS[@]}"; do
            echo "---------------------------------------------------"
            echo "Repairing $v..."
            # Using || true to continue if already applied (idempotent-ish attempt)
            npx supabase migration repair "$v" --status applied || echo "‚ö†Ô∏è Repair failed for $v (might already exist)"
          done

          echo "‚úÖ Repair run complete. Verifying status..."
          npx supabase migration list
