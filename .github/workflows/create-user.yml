name: Manual Call Edge Function

# ARCHITECTURE: "2-Stage Key" Synchronized Auth
# This workflow provisions local/E2E test users onto the live Supabase instance.
# - Stage 1 (Routing): Uses 'apikey' header with ANON key to clear the Supabase Gateway (Kong).
# - Stage 2 (Auth): Uses 'Authorization: Bearer' header with AGENT_SECRET for function authorization.

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Email (username)'
        required: true
      password:
        description: 'Password (>6 alphanumeric, or leave blank for random)'
        required: false
      type:
        description: 'User Type (free or pro)'
        required: false
        default: 'free'
        type: choice
        options:
          - free
          - pro

jobs:
  deploy-and-call:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Manual Call Edge Function
        env:
          AGENT_SECRET: ${{ secrets.AGENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail

          # Generate 24-char POSIX password if needed
          PASSWORD=$(LC_ALL=C tr -dc 'A-Za-z0-9@#%_-+' < /dev/urandom | head -c 24)
          echo "::add-mask::$PASSWORD"

          EMAIL="${{ github.event.inputs.username }}"
          TYPE="${{ github.event.inputs.type }}" # free|pro

          # ðŸ” DIAGNOSTIC: Verify secrets are present (masked)
          echo "--- ðŸ” Headers Diagnostic ---"
          if [ -n "$AGENT_SECRET" ]; then echo "âœ… AGENT_SECRET is present"; else echo "âŒ AGENT_SECRET is MISSING"; fi
          if [ -n "$SUPABASE_ANON_KEY" ]; then echo "âœ… SUPABASE_ANON_KEY is present"; else echo "âŒ SUPABASE_ANON_KEY is MISSING"; fi
          echo "Processing for: $EMAIL (Dual-Header Mode)"

          # Build the payload
          PAYLOAD=$(jq -n \
            --arg email "$EMAIL" \
            --arg password "$PASSWORD" \
            --arg subscription_status "$TYPE" \
            '{ email: $email, password: $password, subscription_status: $subscription_status }')

          # Call Edge Function with full diagnostic output
          # -D: Save response headers
          # -o: Save response body
          curl -sS -i -X POST "${SUPABASE_URL}/functions/v1/create-user" \
            -H "Content-Type: application/json" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${AGENT_SECRET}" \
            -d "$PAYLOAD" \
            -D /tmp/create_user_headers.txt \
            -o /tmp/create_user_response.json \
            -w "%{http_code}" > /tmp/http_status.txt

          HTTP_STATUS=$(cat /tmp/http_status.txt)
          RESP_BODY=$(cat /tmp/create_user_response.json || true)
          
          echo "--- ðŸ” Response Diagnostic ---"
          echo "HTTP Status Code: $HTTP_STATUS"
          echo "Response Headers:"
          cat /tmp/create_user_headers.txt | grep -E "x-sb-edge-region|content-type|x-served-by|sb-request-id" || true
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ API Gateway or Edge Function returned HTTP $HTTP_STATUS"
            echo "Body: $RESP_BODY" | sed -e "s/$PASSWORD/[REDACTED]/g"
            exit 1
          fi

          if command -v jq >/dev/null 2>&1; then
            OK=$(printf '%s' "$RESP_BODY" | jq -r '.success // false')
            if [ "$OK" != "true" ]; then
              echo "âŒ Edge Function returned success=false:"
              printf '%s\n' "$RESP_BODY" | jq .
              exit 1
            fi
          fi

          echo "âœ… Successfully upserted user_profiles for: $EMAIL"
          
          # Store password for potential subsequent steps (Restricted access)
          printf '%s' "$PASSWORD" > /tmp/test_user_password.txt
          chmod 600 /tmp/test_user_password.txt

      - name: Upload Debug Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: create-user-debug-logs
          path: |
            /tmp/create_user_headers.txt
            /tmp/create_user_response.json
          retention-days: 1
