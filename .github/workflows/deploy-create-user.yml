name: Deploy and call Edge Function

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Email (username)'
        required: true
      password:
        description: 'Password (>6 alphanumeric)'
        required: true

jobs:
  deploy-and-call:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install supabase CLI
        uses: supabase/cli-action@v1
        with:
          version: '1.52.0'

      - name: Login supabase CLI
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_CLI_SERVICE_TOKEN }}
        run: |
          supabase login
          # Using project ref: yxlapjuovrsvjswkwnrk
          supabase link --project-ref yxlapjuovrsvjswkwnrk

      - name: Deploy Edge Function
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Function is in backend/supabase/functions/create-user
          # Note: user's example path was supabase/functions/create_user, ours is backend/supabase/functions/create-user
          # We need to make sure the CLI finds it. 
          # The CLI expects functions to be in ./supabase/functions by default or defined in config.toml
          # If we run from root, we might need to cd or configure.
          # For safety, I'll try to deploy pointing to the right path if the CLI supports it, or symlink.
          # But `supabase functions deploy` expects the name of the function folder inside `supabase/functions`.
          # Our structure is `backend/supabase/functions`.
          # I should probably cd into `backend` before running supabase commands?
          # Or move the folder?
          # I'll cd into backend.
          
          cd backend
          supabase functions deploy create-user --project-ref yxlapjuovrsvjswkwnrk --no-verify-jwt

      - name: Wait for deployed function to become available
        run: sleep 5

      - name: Call Edge Function
        env:
          AGENT_SECRET: ${{ secrets.AGENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          echo "Calling edge function..."
          # Fix: Function name is create-user (file saved as index.ts in that folder)
          RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/create-user" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${{ github.event.inputs.username }}\",\"password\":\"${{ github.event.inputs.password }}\",\"agent_secret\":\"${{ secrets.AGENT_SECRET }}\"}" \
            -w "\nHTTP_STATUS:%{http_code}\n")
          echo "$RESPONSE"
