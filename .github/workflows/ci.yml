name: "CI - Test Audit"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.shard.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - run: pnpm install --frozen-lockfile

      - name: Prepare Stage (lint/typecheck/build/shard)
        id: shard
        run: |
          ./test-audit.sh prepare
          COUNT=$(jq '.shard_count' ./test-support/e2e-shards.json)
          INDICES=$(seq 0 $((COUNT-1)) | jq -R . | jq -s . | jq -c .)
          echo "matrix=$INDICES" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: prepare-artifacts
          path: |
            dist
            test-support
            unit-metrics.json
            test-results/coverage

  test:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard-index: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - run: pnpm install --frozen-lockfile

      - uses: actions/download-artifact@v4
        with:
          name: prepare-artifacts
          path: .

      # üî• ensure file exists (fixes your jq error)
      - name: Verify shard file
        run: |
          test -f ./test-support/e2e-shards.json || (echo "‚ùå Missing shard file" && exit 1)

      # üî• Run shard + output dedicated Playwright report
      - name: Run E2E Shard
        run: |
          mkdir -p shard-report
          ./test-audit.sh test ${{ matrix.shard-index }}
          pnpm exec playwright show-trace || true
          cp -r test-results/playwright shard-report/

      - uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard-index }}
          path: shard-report

  report:
    needs: [prepare, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - run: pnpm install --frozen-lockfile

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge all Playwright reports
        run: |
          mkdir -p merged
          find artifacts -name 'shard-*' -type d -exec cp -r {}/. merged/ \;
          echo "üìÑ Reports found:"
          ls -R merged
          pnpm exec playwright merge-reports merged

      - name: Generate Final Documentation
        run: ./test-audit.sh report
