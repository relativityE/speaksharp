name: "CI - Test Audit"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.shard.outputs.matrix }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Ensure e2e-shards.json exists
        run: |
          mkdir -p test-support
          if [ ! -f test-support/e2e-shards.json ]; then
            echo '{"shard_count": 0}' > test-support/e2e-shards.json
          fi
      - name: Run Prepare Stage (Lint, Typecheck, Build, Unit, Shard)
        id: shard
        run: |
          ./test-audit.sh prepare
          COUNT=$(jq '.shard_count' ./test-support/e2e-shards.json)
          INDICES=$(seq 0 $((COUNT-1)) | jq -R . | jq -s . | jq -c .)
          echo "matrix=$INDICES" >> $GITHUB_OUTPUT
      - name: Upload All Prepare-Stage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-artifacts
          path: |
            dist
            test-results/coverage
            test-support
            unit-metrics.json

  test:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard-index: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Download Prepare-Stage Artifacts
        uses: actions/download-artifact@v4
        with:
          name: all-artifacts
          path: .
      - name: Run E2E Test Shard
        run: |
          mkdir -p test-results/playwright/shard-${{ matrix.shard-index }}
          ./test-audit.sh test ${{ matrix.shard-index }}
          # Copy Playwright JSON report to shard-specific folder
          cp -r test-results/playwright/* test-results/playwright/shard-${{ matrix.shard-index }}/ || true
      - name: Upload E2E Shard Report
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard-index }}
          path: test-results/playwright/shard-${{ matrix.shard-index }}

  report:
    needs: [prepare, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Download All Workflow Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Merge E2E Shard Reports
        run: |
          mkdir -p merged-report
          find artifacts -name 'shard-*' -type d -exec cp -r {}/. merged-report/ \;
          echo "ðŸ“„ Reports found:"
          ls -R merged-report
          pnpm exec playwright merge-reports merged-report
      - name: Consolidate Final Artifacts
        run: |
          mkdir -p test-results/coverage
          cp artifacts/all-artifacts/unit-metrics.json .
          cp -r artifacts/all-artifacts/test-results/coverage/. test-results/coverage
          cp -r artifacts/all-artifacts/dist .
      - name: Generate Final Report and Update Docs
        run: ./test-audit.sh report
      - name: Commit documentation changes
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(sqm): Update test audit metrics"
          branch: ${{ github.head_ref || github.ref_name }}
          file_pattern: 'docs/PRD.md'
