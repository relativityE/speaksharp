name: "CI - Test Audit"

permissions:
  contents: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.shard.outputs.matrix }}
      shard-count: ${{ steps.shard.outputs.shard-count }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Ensure e2e-shards.json exists
        run: |
          mkdir -p test-support
          if [ ! -f test-support/e2e-shards.json ]; then
            echo '{"shard_count": 0}' > test-support/e2e-shards.json
          fi

      - name: Run Prepare Stage
        id: shard
        run: |
          ./scripts/test-audit.sh prepare
          COUNT=$(jq '.shard_count' ./test-support/e2e-shards.json)
          echo "shard-count=$COUNT" >> $GITHUB_OUTPUT
          if [ "$COUNT" -eq 0 ]; then
            INDICES="[]"
          else
            INDICES=$(seq 0 $((COUNT-1)) | jq -R . | jq -s . | jq -c .)
          fi
          echo "matrix=$INDICES" >> $GITHUB_OUTPUT

      - name: Upload Prepare Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-artifacts
          path: |
            frontend/dist
            frontend/coverage
            test-support
            unit-metrics.json

  test:
    needs: prepare
    if: needs.prepare.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard-index: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Download Prepare Artifacts
        uses: actions/download-artifact@v4
        with:
          name: all-artifacts
          path: .

      - name: Run E2E Test Shard
        run: ./scripts/test-audit.sh test ${{ matrix.shard-index }}

      - name: Upload Shard Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shard-report-${{ matrix.shard-index }}
          path: test-results/shards/shard-${{ matrix.shard-index }}
          retention-days: 30

  lighthouse:
    needs: [prepare, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Restore Build Artifacts
        run: |
          cp -r artifacts/all-artifacts/frontend/dist .
          cp -r artifacts/all-artifacts/frontend/coverage ./frontend/coverage
          cp -r artifacts/all-artifacts/test-results .
          cp artifacts/all-artifacts/unit-metrics.json .

      - name: Start Preview Server
        run: |
          pnpm preview &
          npx wait-on http://localhost:4173

      - name: Run Lighthouse CI
        run: npx lhci autorun

      - name: Upload Lighthouse Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: ./.lhci
          retention-days: 30

  report:
    needs: [prepare, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Restore Build Artifacts
        run: |
          cp -r artifacts/all-artifacts/frontend/dist .
          cp -r artifacts/all-artifacts/test-results .
          cp artifacts/all-artifacts/unit-metrics.json .

      - name: Merge E2E Reports
        run: |
          mkdir -p merged-reports
          mkdir -p test-results/playwright
          # Copy all shard blob reports
          # Blobs are usually named report-*.zip
          find artifacts -type f -name 'report-*.zip' | while read report; do
            shard_name=$(basename $(dirname "$report"))
            cp "$report" "merged-reports/${shard_name}.zip"
          done

          # List what we found
          echo "üìÑ Shard reports found:"
          ls -la merged-reports/

          # Only merge if we have reports
          if [ "$(ls -A merged-reports 2>/dev/null)" ]; then
            # Merge reports. 
            # JSON to stdout -> captured to file
            # HTML to playwright-report/ (default)
            pnpm exec playwright merge-reports --reporter json,html merged-reports > test-results/playwright/results.json
            
            echo "‚úÖ Merged E2E report saved to test-results/playwright/results.json"
          else
            echo "‚ö†Ô∏è No E2E reports to merge (tests may have been skipped)"
          fi

      - name: Generate Final Report
        run: ./scripts/test-audit.sh report

      - name: Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Commit Documentation Updates
        if: success() && github.event_name == 'push'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          commit_message: "docs(sqm): Update test audit metrics"
          branch: ${{ github.head_ref || github.ref_name }}
          file_pattern: 'docs/PRD.md'
